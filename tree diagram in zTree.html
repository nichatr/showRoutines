<!DOCTYPE html>
<html>
  <head>
    <title>TITLE</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />

    <link href="..\prism.css" rel="stylesheet" />
    <link
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
      crossorigin="anonymous"
    />
    <!-- <link
      rel="stylesheet"
      href="../zTree/css/zTreeStyle/zTreeStyle.css"
      type="text/css"
    /> -->
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/zTree.v3/3.5.40/css/zTreeStyle/zTreeStyle.css"
    type="text/css" /> -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/ztree@3.5.24/css/zTreeStyle/zTreeStyle.css"
      integrity="sha256-cr76XHBuc5/WlSeWBTtCaqsVohyJPiIWIMRufFvWK+M="
      crossorigin="anonymous"
    />
    <style>
      .ztree li a {
        height: 1.5em;
        font-size: 1.3em;
        /* font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace; */
      }
    </style>

    <script
      src="https://code.jquery.com/jquery-3.4.1.min.js"
      integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
      crossorigin="anonymous"
    ></script>

    <script src="https://cdn.jsdelivr.net/npm/ztree@3.5.24/js/jquery.ztree.all.min.js"></script>

    <!-- <script type="text/javascript" src="../zTree/js/jquery.ztree.core.min.js"></script>
    <script type="text/javascript" src="../zTree/js/jquery.ztree.excheck.min.js"></script>
    <script type="text/javascript" src="../zTree/js/jquery.ztree.exedit.min.js"></script> -->

    <script type="text/javascript">
      var zNodes = [];
      var myCode = ``;

      var setting = {
        data: {
          key: {
            title: 't',
          },
          simpleData: {
            enable: true,
          },
        },
        view: {
          // fontCss: getFont,
          showIcon: false, // set showIconForTree if you need icon for nodes with children
          expandSpeed: '', // no delay in expand/collapse
          // addHoverDom: addHoverDom,
          // removeHoverDom: removeHoverDom,
          selectedMulti: false,
        },
        // edit: {
        //   enable: true,
        //   editNameSelectAll: true,
        //   showRemoveBtn: showRemoveBtn,
        //   showRenameBtn: showRenameBtn
        // },
        callback: {
          // beforeRemove: beforeRemove,
          // beforeRename: beforeRename,
          onClick: myOnClick,
        },
      };

      var log,
        className = 'dark';

      var selectedCode = myCode;
      
      function getFont(treeId, node) {
			  return {'font-size': '1.3em', 'font-family':'Consolas, Monaco, monospace' };
		  }

      function myOnClick(event, treeId, treeNode) {
        // search treeNode in array of nodes.
        const index = zNodes.findIndex((item) => item.name === treeNode.name);
        const startStmt = parseInt(zNodes[index].start);
        const endStmt = parseInt(zNodes[index].end);
        selectedCode = '';
        myCode.split(/^/m).reduce((a, c, i) => {
          if (i >= startStmt - 1 && i <= endStmt)
            selectedCode = selectedCode + c;
        });

        code = Prism.highlight(selectedCode, Prism.languages.cobol, 'cobol');
        $('#myCode').html(code);

        // alert(treeNode.tId + ", " + index + ", " + treeNode.name + ", " + zNodes[index].start);
      }

      function beforeRemove(treeId, treeNode) {
        var zTree = $.fn.zTree.getZTreeObj('treeDemo');
        zTree.selectNode(treeNode);
        return confirm("Confirm delete node '" + treeNode.name + "' it?");
      }

      function beforeRename(treeId, treeNode, newName, isCancel) {
        if (newName.length == 0) {
          setTimeout(function () {
            var zTree = $.fn.zTree.getZTreeObj('treeDemo');
            zTree.cancelEditName();
            alert('Node name can not be empty.');
          }, 0);
          return false;
        }
        return true;
      }

      function showRemoveBtn(treeId, treeNode) {
        return !treeNode.isFirstNode;
      }

      function showRenameBtn(treeId, treeNode) {
        return !treeNode.isLastNode;
      }

      var newCount = 1;

      function addHoverDom(treeId, treeNode) {
        var sObj = $('#' + treeNode.tId + '_span');
        if (treeNode.editNameFlag || $('#addBtn_' + treeNode.tId).length > 0)
          return;
        var addStr =
          "<span class='button add' id='addBtn_" +
          treeNode.tId +
          "' title='add node' onfocus='this.blur();'></span>";
        sObj.after(addStr);
        var btn = $('#addBtn_' + treeNode.tId);
        if (btn)
          btn.bind('click', function () {
            var zTree = $.fn.zTree.getZTreeObj('treeDemo');
            zTree.addNodes(treeNode, {
              id: 100 + newCount,
              pId: treeNode.id,
              name: 'new node' + newCount++,
            });
            return false;
          });
      }

      function removeHoverDom(treeId, treeNode) {
        $('#addBtn_' + treeNode.tId)
          .unbind()
          .remove();
      }

      $(document).ready(function () {
        $.fn.zTree.init($('#treeDemo'), setting, zNodes);

        // initially the selected code is all source code.
        const code = Prism.highlight(
          selectedCode,
          Prism.languages.cobol,
          'cobol'
        );
        $('#myCode').html(code);
        resizePanels()

        $('#downloadBtn').bind('click', downloadAll);
        $('#expandAllBtn').bind('click', expandAll);
        $('#collapseAllBtn').bind('click', collapseAll);
        $('#expandLevelBtn').bind('click', expandLevel);
        $('#collapseLevelBtn').bind('click', collapseLevel);
      });

      function resizePanels() {
        // var width = window.innerWidth - 50;
        var height = window.innerHeight - 130;

        $(".zTreeDemoBackground").css("max-height",`${height}px`);
        $(".code").css("max-height",`${height}px`);
      }


      function downloadAll() {
        var xx = document.querySelector('html').innerHTML;
        download('saved.html', xx);
      }

      function download(filename, text) {
        var element = document.createElement('a');
        element.setAttribute(
          'href',
          'data:text/plain;charset=utf-8,' + encodeURIComponent(text)
        );
        element.setAttribute('download', filename);

        element.style.display = 'none';
        document.body.appendChild(element);

        element.click();

        document.body.removeChild(element);
      }

      function expandAll() {
        var zTree = $.fn.zTree.getZTreeObj('treeDemo');
        zTree.expandAll(true);
      }

      function collapseAll() {
        var zTree = $.fn.zTree.getZTreeObj('treeDemo');
        zTree.expandAll(false);
      }

      function expandLevel() {
        var zTree = $.fn.zTree.getZTreeObj('treeDemo');
        var sNodes = zTree.getSelectedNodes();
        if (sNodes.length > 0) {
          zTree.expandNode(sNodes[0], true, true);

          var node = sNodes[0].getNextNode();
          while (node != null) {
            zTree.expandNode(node, true, false);
            var node = node.getNextNode();
          }
        }
      }

      function collapseLevel() {
        var zTree = $.fn.zTree.getZTreeObj('treeDemo');
        var sNodes = zTree.getSelectedNodes();
        if (sNodes.length > 0) {
          zTree.expandNode(sNodes[0], false, true);

          var node = sNodes[0].getNextNode();
          while (node != null) {
            zTree.expandNode(node, false, true);
            var node = node.getNextNode();
          }
        }
      }
    </script>

    <style type="text/css">
      .ztree li span.button.add {
        margin-left: 2px;
        margin-right: -1px;
        background-position: -144px 0;
        vertical-align: top;
        *vertical-align: middle;
      }

      .badge {
        color: #4d85ff;
      }
      .badge {
        background-color: #e6e6fa;
      }
    </style>
  </head>

  <body class="line-numbers">
    <!-- <div class="container"> -->
    <nav class="navbar sticky-top navbar-expand-lg navbar-light bg-light">
      <div class="navbar-brand">
        <span class="badge">
          <h5>TITLE</h5>
        </span>
      </div>

      <button
        class="navbar-toggler"
        type="button"
        data-toggle="collapse"
        data-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent"
        aria-expanded="false"
        aria-label="Toggle navigation"
      >
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <button id="expandAllBtn" class="btn btn-primary btn-sm">
              Expand all
            </button>
          </li>
          <li class="nav-item">
            <button id="collapseAllBtn" class="btn btn-primary btn-sm">
              Collapse all
            </button>
          </li>
          <li class="nav-item">
            <button id="expandLevelBtn" class="btn btn-secondary btn-sm">
              Expand level
            </button>
          </li>
          <li class="nav-item">
            <button id="collapseLevelBtn" class="btn btn-secondary btn-sm">
              Collapse level
            </button>
          </li>
          <li class="nav-item">
            <button id="downloadBtn" class="btn btn-success btn-sm">
              Save
            </button>
          </li>
        </ul>
      </div>
    </nav>

    <div class="row">
      <div class="col-sm-4">
        <div class="card">
          <div class="card-body">
            <div class="zTreeDemoBackground overflow-auto" style="max-height: 500px; background-color: #f5f2f0">
              <ul id="treeDemo" class="ztree"></ul>
            </div>
          </div>
        </div>
      </div>

      <div class="col-sm-8">
        <div class="card ">
          <div class="card-body" >
            <div class="code overflow-auto" style="max-height: 1000px">
              <pre><code class="language-cobol" id="myCode">

              </code></pre>
          </div>
        </div>
      </div>
    <!-- </div> -->
    <!-- </div> -->

    <script
      src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
      integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
      crossorigin="anonymous"
    ></script>

    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
      integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
      crossorigin="anonymous"
    ></script>

    <script src="..\prism.js"></script>
  </body>
</html>
